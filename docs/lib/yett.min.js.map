{"version":3,"file":"yett.min.js","sources":["../../src/checks.js","../../src/variables.js","../../src/observer.js","../../src/monkey.js","../../src/unblock.js"],"sourcesContent":["import { patterns, TYPE_ATTRIBUTE } from './variables';\n\nexport const isOnBlacklist = (src, type) =>\n  src &&\n  (!type || type !== TYPE_ATTRIBUTE) &&\n  ((!patterns.blacklist || patterns.blacklist.some((pattern) => pattern.test(src))) &&\n    (!patterns.whitelist || patterns.whitelist.every((pattern) => !pattern.test(src))));\n\nexport const willBeUnblocked = function(script) {\n  const src = script.getAttribute('src');\n  return (\n    (patterns.blacklist && patterns.blacklist.every((entry) => !entry.test(src))) ||\n    (patterns.whitelist && patterns.whitelist.some((entry) => entry.test(src)))\n  );\n};\n","export const TYPE_ATTRIBUTE = 'javascript/blocked';\n\nexport const patterns = {\n  blacklist: window.YETT_BLACKLIST,\n  whitelist: window.YETT_WHITELIST,\n};\n\n// Backup list containing the original blacklisted script elements\nexport const backupScripts = {\n  blacklisted: [],\n};\n","import { backupScripts, TYPE_ATTRIBUTE } from './variables';\nimport { isOnBlacklist } from './checks';\n\n// Setup a mutation observer to track DOM insertion\nexport const observer = new MutationObserver((mutations) => {\n  for (let i = 0; i < mutations.length; i++) {\n    const { addedNodes } = mutations[i];\n    for (let i = 0; i < addedNodes.length; i++) {\n      const node = addedNodes[i];\n      // For each added script tag\n      if (node.nodeType === 1 && node.tagName === 'SCRIPT') {\n        const src = node.src;\n        const type = node.type;\n        // If the src is inside the blacklist and is not inside the whitelist\n        if (isOnBlacklist(src, type)) {\n          // We backup a copy of the script node\n          backupScripts.blacklisted.push(node.cloneNode());\n\n          // Blocks inline script execution in Safari & Chrome\n          node.type = TYPE_ATTRIBUTE;\n\n          // Firefox has this additional event which prevents scripts from beeing executed\n          const beforeScriptExecuteListener = function(event) {\n            // Prevent only marked scripts from executing\n            if (node.getAttribute('type') === TYPE_ATTRIBUTE) event.preventDefault();\n            node.removeEventListener('beforescriptexecute', beforeScriptExecuteListener);\n          };\n          node.addEventListener('beforescriptexecute', beforeScriptExecuteListener);\n\n          // Remove the node from the DOM\n          node.parentElement && node.parentElement.removeChild(node);\n        }\n      }\n    }\n  }\n});\n\n// Starts the monitoring\nobserver.observe(document.documentElement, {\n  childList: true,\n  subtree: true,\n});\n","import { TYPE_ATTRIBUTE } from './variables';\nimport { isOnBlacklist } from './checks';\n\nconst createElementBackup = document.createElement;\n\n// Monkey patch the createElement method to prevent dynamic scripts from executing\ndocument.createElement = function(...args) {\n  // If this is not a script tag, bypass\n  if (args[0].toLowerCase() !== 'script') return createElementBackup.bind(document)(...args);\n\n  const scriptElt = createElementBackup.bind(document)(...args);\n  const originalSetAttribute = scriptElt.setAttribute.bind(scriptElt);\n\n  // Define getters / setters to ensure that the script type is properly set\n  Object.defineProperties(scriptElt, {\n    src: {\n      get() {\n        return scriptElt.getAttribute('src');\n      },\n      set(value) {\n        if (isOnBlacklist(value, scriptElt.type)) {\n          originalSetAttribute('type', TYPE_ATTRIBUTE);\n        }\n        originalSetAttribute('src', value);\n        return true;\n      },\n    },\n    type: {\n      set(value) {\n        const typeValue = isOnBlacklist(scriptElt.src, scriptElt.type) ? TYPE_ATTRIBUTE : value;\n        originalSetAttribute('type', typeValue);\n        return true;\n      },\n    },\n  });\n\n  // Monkey patch the setAttribute function so that the setter is called instead\n  scriptElt.setAttribute = function(name, value) {\n    if (name === 'type' || name === 'src') scriptElt[name] = value;\n    else HTMLScriptElement.prototype.setAttribute.call(scriptElt, name, value);\n  };\n\n  return scriptElt;\n};\n","import { patterns, backupScripts, TYPE_ATTRIBUTE } from './variables';\n\nimport { willBeUnblocked } from './checks';\n\nimport { observer } from './observer';\n\nconst URL_REPLACER_REGEXP = new RegExp('[|\\\\{}()[\\\\]^$+*?.]', 'g');\n\n// Unblocks all (or a selection of) blacklisted scripts.\nexport const unblock = function(...scriptUrlsOrRegexes) {\n  if (scriptUrlsOrRegexes.length < 1) {\n    patterns.blacklist = [];\n    patterns.whitelist = [];\n  } else {\n    if (patterns.blacklist) {\n      patterns.blacklist = patterns.blacklist.filter((pattern) =>\n        scriptUrlsOrRegexes.every((urlOrRegexp) => {\n          if (typeof urlOrRegexp === 'string') return !pattern.test(urlOrRegexp);\n          else if (urlOrRegexp instanceof RegExp)\n            return pattern.toString() !== urlOrRegexp.toString();\n        }),\n      );\n    }\n    if (patterns.whitelist) {\n      patterns.whitelist = [\n        ...patterns.whitelist,\n        ...scriptUrlsOrRegexes\n          .map((urlOrRegexp) => {\n            if (typeof urlOrRegexp === 'string') {\n              const escapedUrl = urlOrRegexp.replace(URL_REPLACER_REGEXP, '\\\\$&');\n              const permissiveRegexp = '.*' + escapedUrl + '.*';\n              if (patterns.whitelist.every((p) => p.toString() !== permissiveRegexp.toString())) {\n                return new RegExp(permissiveRegexp);\n              }\n            } else if (urlOrRegexp instanceof RegExp) {\n              if (patterns.whitelist.every((p) => p.toString() !== urlOrRegexp.toString())) {\n                return urlOrRegexp;\n              }\n            }\n            return null;\n          })\n          .filter(Boolean),\n      ];\n    }\n  }\n\n  // Parse existing script tags with a marked type\n  const tags = document.querySelectorAll(`script[type=\"${TYPE_ATTRIBUTE}\"]`);\n  for (let i = 0; i < tags.length; i++) {\n    const script = tags[i];\n    if (willBeUnblocked(script)) {\n      script.type = 'application/javascript';\n      backupScripts.blacklisted.push(script);\n      script.parentElement.removeChild(script);\n    }\n  }\n\n  // Exclude 'whitelisted' scripts from the blacklist and append them to <head>\n  let indexOffset = 0;\n  [...backupScripts.blacklisted].forEach((script, index) => {\n    if (willBeUnblocked(script)) {\n      const scriptNode = document.createElement('script');\n      scriptNode.setAttribute('src', script.src);\n      scriptNode.setAttribute('type', 'application/javascript');\n      document.head.appendChild(scriptNode);\n      backupScripts.blacklisted.splice(index - indexOffset, 1);\n      indexOffset++;\n    }\n  });\n\n  // Disconnect the observer if the blacklist is empty for performance reasons\n  if (patterns.blacklist && patterns.blacklist.length < 1) {\n    observer.disconnect();\n  }\n};\n"],"names":["isOnBlacklist","src","type","TYPE_ATTRIBUTE","patterns","blacklist","some","pattern","test","whitelist","every","willBeUnblocked","script","getAttribute","entry","window","YETT_BLACKLIST","YETT_WHITELIST","backupScripts","blacklisted","observer","MutationObserver","mutations","i","length","addedNodes","node","nodeType","tagName","push","cloneNode","addEventListener","beforeScriptExecuteListener","event","preventDefault","removeEventListener","parentElement","removeChild","observe","document","documentElement","childList","subtree","createElementBackup","createElement","args","toLowerCase","bind","scriptElt","originalSetAttribute","setAttribute","Object","defineProperties","get","set","value","typeValue","name","HTMLScriptElement","prototype","call","URL_REPLACER_REGEXP","RegExp","scriptUrlsOrRegexes","filter","urlOrRegexp","toString","map","permissiveRegexp","replace","p","Boolean","tags","querySelectorAll","indexOffset","forEach","index","scriptNode","head","appendChild","splice","disconnect"],"mappings":"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"}